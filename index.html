<!-- AGREGA ESTO AL FINAL DE TU <script> SIN QUITAR NADA -->

/* =========================
   FACE ID REAL (WebAuthn)
   ========================= */

async function webAuthnSupported(){
  return window.PublicKeyCredential &&
         await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
}

async function registerFaceID(){
  if(!(await webAuthnSupported())){
    alert("Face ID no disponible en este dispositivo");
    faceSwitch.checked=false;
    localStorage.setItem("faceID","false");
    return;
  }

  const challenge = new Uint8Array(32);
  crypto.getRandomValues(challenge);

  const credential = await navigator.credentials.create({
    publicKey:{
      challenge,
      rp:{ name:"CM Card" },
      user:{
        id:crypto.getRandomValues(new Uint8Array(16)),
        name:"cmcard@local",
        displayName:"CM Card User"
      },
      pubKeyCredParams:[{ type:"public-key", alg:-7 }],
      authenticatorSelection:{
        authenticatorAttachment:"platform",
        userVerification:"required"
      },
      timeout:60000
    }
  });

  localStorage.setItem(
    "faceCredential",
    JSON.stringify(Array.from(new Uint8Array(credential.rawId)))
  );
}

async function authenticateFaceID(){
  const raw = JSON.parse(localStorage.getItem("faceCredential")||"null");
  if(!raw) return false;

  const challenge = new Uint8Array(32);
  crypto.getRandomValues(challenge);

  try{
    await navigator.credentials.get({
      publicKey:{
        challenge,
        allowCredentials:[{
          id:new Uint8Array(raw),
          type:"public-key"
        }],
        userVerification:"required",
        timeout:60000
      }
    });
    return true;
  }catch{
    return false;
  }
}

/* =========================
   OVERRIDE QUIRÚRGICO
   ========================= */

faceSwitch.onchange = async ()=>{
  if(faceSwitch.checked){
    await registerFaceID();
    localStorage.setItem("faceID","true");
  }else{
    localStorage.removeItem("faceCredential");
    localStorage.setItem("faceID","false");
  }
};

/* REEMPLAZA SOLO LA LÓGICA INTERNA,
   SIN BORRAR TU FUNCIÓN */
const originalSecureAction = secureAction;

secureAction = async function(code){
  if(activeCard===null){
    alert("Selecciona una tarjeta");
    return;
  }

  if(face){
    faceModal.style.display="flex";

    const ok = await authenticateFaceID();
    faceModal.style.display="none";

    if(!ok){
      alert("Face ID falló");
      return;
    }
  }

  window.location.href="tel:"+code;
};
